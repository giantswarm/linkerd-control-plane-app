{{if .Values.identity -}}
{{if and (.Values.identity.issuer) (eq .Values.identity.issuer.scheme "linkerd.io/cert-manager") -}}
---
apiVersion: {{ template "cert-manager.apiversion" . }}
kind: Issuer
metadata:
  name: linkerd-selfsigning-issuer
  namespace: {{.Release.Namespace}}
  labels:
    {{.Values.global.controllerComponentLabel}}: identity
    {{.Values.global.controllerNamespaceLabel}}: {{.Release.Namespace}}
  annotations:
    {{.Values.global.createdByAnnotation}}: {{ printf "linkerd/helm %s" .Values.global.linkerdVersion }}
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "-5"
spec:
  selfSigned: {}
---
apiVersion: {{ template "cert-manager.apiversion" . }}
kind: Certificate
metadata:
  name: linkerd-identity-issuer
  namespace: {{.Release.Namespace}}
  labels:
    {{.Values.global.controllerComponentLabel}}: identity
    {{.Values.global.controllerNamespaceLabel}}: {{.Release.Namespace}}
  annotations:
    {{.Values.global.createdByAnnotation}}: {{ printf "linkerd/helm %s" .Values.global.linkerdVersion }}
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "-5"
spec:
  secretName: linkerd-identity-issuer
  commonName: identity.{{.Release.Namespace}}.{{.Values.global.clusterDomain}}
  isCA: true
  keyAlgorithm: ecdsa
  issuerRef:
    name: linkerd-selfsigning-issuer
{{- end}}
{{- end}}
